name: Build and Deploy

on:
  push:
    branches:
      - cicd
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME }}
      AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install azd
      uses: Azure/setup-azd@v0.1.0

    - name: Login to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: azd auth login
      run: |
        AZURE_CLIENT_ID=$(echo "$AZURE_CREDENTIALS" | jq -r '.clientId')
        AZURE_TENANT_ID=$(echo "$AZURE_CREDENTIALS" | jq -r '.tenantId')
        AZURE_CLIENT_SECRET=$(echo "$AZURE_CREDENTIALS" | jq -r '.clientSecret')
        AZURE_SUBSCRIPTION_ID=$(echo "$AZURE_CREDENTIALS" | jq -r '.subscriptionId')
        
        azd version

        azd auth login --client-id $AZURE_CLIENT_ID --client-secret $AZURE_CLIENT_SECRET --tenant-id $AZURE_TENANT_ID
        
        azd env new $AZURE_ENV_NAME --subscription $AZURE_SUBSCRIPTION_ID

        azd show

    - name: azd up
      run: |
        azd version
        azd show
        azd up --no-prompt
        azd show